# Домашнее задание 5

Тема: построение регрессионных моделей и анализ выживаемости.

Цель: научиться пользоваться основными методами регрессионного анализа, разобраться с принципами анализа выживаемости.


# Описание ДЗ

Для выполнения первых двух заданий загрузите датасет Breast Cancer Wisconsin.

В колонке diagnosis содержится информация об опухоли (M = злокачественная, B = доброкачественная).

Выполните перечисленные задания.
```{r}
library(ggplot2)
library(tidyverse)
```

```{r}
cancer <- read.csv("data/wisconsin_breast_cancer.csv")

head(cancer)
```
## Задание 1 (2 балла)

Создайте регрессионную модель, которая бы описывала связь среднего радиуса опухоли и средней площади (а), среднего периметра (б), средней симметричности (в).

Постройте графики, на которых отразите регрессионную прямую, и прокомментируйте свои находки.

```{r}
model <- lm(radius_mean ~ area_mean + perimeter_mean + symmetry_mean, data = cancer)
summary(model)
```
Постройте графики, на которых отразите регрессионную прямую, и прокомментируйте свои находки.
```{r}
cancer %>%
    ggplot(aes(x = area_mean, y = radius_mean)) +
    geom_point() +
    labs(title = "Зависимость радиуса и площади опухоли",
      x = "площадь опухоли",
      y = "радиус опухоли") + 
    geom_smooth(method = "lm")
cancer %>%
    ggplot(aes(x = perimeter_mean, y = radius_mean)) +
    geom_point() +
    labs(title = "Зависимость радиуса и периметра опухоли",
      x = "периметр опухоли",
      y = "радиус опухоли") +
    geom_smooth(method = "lm")
cancer %>%
    ggplot(aes(x = symmetry_mean, y = radius_mean)) +
    geom_point() +
    labs(title = "Зависимость радиуса и симметричности опухоли",
      x = "симметричность опухоли",
      y = "радиус опухоли") +
    geom_smooth(method = "lm")
```

Признаки площадь опухоли и периметр имеют линейную зависимость, возможно данные коррелируют друг с другом, для того, чтобы избавиться от мультиколлинеарности требуется удалить один из признаков, иначе модель будет переобучаться на тренировочной выборке и не давать реальные данные на валидационной выборке

## Задание 2 (2 балла)

Пусть колонка с диагнозом принимает следующие значения: злокачественная опухоль — 1, а доброкачественная — 0. Постройте модель, которая бы прогнозировала вероятность возникновения злокачественной опухоли от среднего радиуса (а), средней площади (б), средней текстуры (в).

Постройте графики. Создайте модель, которая бы прогнозировала вероятность возникновения злокачественной опухоли от всех трех перечисленных факторов.

```{r}
cancer$diagnosis <- ifelse(cancer$diagnosis == 'M', 1, 0)
```

```{r}
logmodel <- glm(diagnosis ~ radius_mean + area_mean + texture_mean, data = cancer, family = "binomial")
summary(logmodel)
```
```{r}
cancer %>%
    ggplot(aes(x = radius_mean, y = diagnosis)) +
    geom_point() +
    labs(title = "Зависимость типа опухоли и радиуса опухоли",
      x = "радиус опухоли",
      y = "Тип опухоли") +
    geom_smooth(method = "glm", method.args = list(family = "binomial"))
cancer %>%
    ggplot(aes(x = area_mean, y = diagnosis)) +
    geom_point() +
    labs(title = "Зависимость типа опухоли и площади опухоли",
      x = "площадь опухоли",
      y = "Тип опухоли") +
    geom_smooth(method = "glm", method.args = list(family = "binomial"))
cancer %>%
    ggplot(aes(x = texture_mean, y = diagnosis)) +
    geom_point() +
    labs(title = "Зависимость типа опухоли и текстуры опухоли",
      x = "текстура опухоли",
      y = "Тип опухоли") +
    geom_smooth(method = "glm", method.args = list(family = "binomial"))
```

```{r}
model2 <- glm(diagnosis ~ radius_mean * area_mean * texture_mean, data = cancer, family = "binomial")

summary(gfit2)
```
## Задание 3 (6 балла)

Для выполнения этого задания вам понадобится датасет lung, который встроен в пакет survival. Установите этот пакет и загрузите датасет.

Датасет содержит следующий набор переменных:

    inst: код учреждения;
    time: время выживаемости в днях;
    status: 1 = цензурирование, 2 = смерть;
    age: возраст в годах;
    sex: мужской = 1, женский = 2;
    ph.ecog: шкала опросника ECOG (оценку проводит врач). 0 = отсутствие симптомов, 1= симптомы есть, но пациент наблюдается амбулаторно, 2 = меньше половины дня пациент вынужден проводить в постели, 3 = больше половины дня нуждается в отдыхе лежа, но не прикован к постели, 4 = прикован к постели;
    ph.karno: шкала Карновского (от 0 до 100, от худшего к лучшему) по оценке врача;
    pat.karno: шкала Карновского (от 0 до 100, от худшего к лучшему) по оценке пациента;
    meal.cal: калории потребляемой пищи;
    wt.loss: потеря веса за последние полгода.

Создайте переменную event, в которой отразите наличие или отсутствие (1 или 0) интересующего события — смерти пациента.

Изучите работу функций Surv(), survfit() и ggsurvplot():

    Постройте кривые выживаемости в зависимости от пола (на одном графике должны получиться две кривые для каждого пола и таблица числа пациентов, подверженных риску (at risk) под ним). Поясните получившееся значение p-value для лог-рангового теста и опишите наблюдаемые результаты.
    Постройте график кумулятивной функции рисков (cumulative hazard function) для пола. Проинтерпретируйте график.
    С помощью функции coxph() постройте регрессию Кокса и оцените влияние пола на выживаемость. Что вы можете сказать о полученных результатах?

```{r}
library(survival)
```

```{r}
lung <- survival::lung
head(lung)
```
```{r}
lung$event <- ifelse(lung$status == 2,1,0)
lung_filt <- filter(lung,lung$event == 1)
```

Изучите работу функций Surv(), survfit() и ggsurvplot():

-   Постройте кривые выживаемости в зависимости от пола (на одном графике должны получиться две кривые для каждого пола и таблица числа пациентов, подверженных риску (at risk) под ним). Поясните получившееся значение p-value для лог-рангового теста и опишите наблюдаемые результаты.

```{r}
library(ggsurvfit)
library(survminer)
```


```{r}
surv_fit <- survfit(Surv(time, status) ~ sex, data = lung_filt)

ggsurvplot(surv_fit, risk.table = TRUE)
```
Поясните получившееся значение p-value для лог-рангового теста и опишите наблюдаемые результаты.

строим лог-ранг тест
```{r}
survdiff(Surv(time, status) ~ sex, data = lung_filt)
```
p-value больше 0.05, значит не отвергаем нулевую гипотезу
Исходя из графика, по времени к концу интервала графики пересекаются, значит статистические значения не различаются между полом

Постройте график кумулятивной функции рисков (cumulative hazard function) для пола. Проинтерпретируйте график.



```{r}
ggsurvplot(surv_fit, fun = "cumhaz")
```
На графике куммулятивной функции рисков доверительные интервалы так же пересекаются, что говорит об отсутствии значимых различий

С помощью функции coxph() постройте регрессию Кокса и оцените влияние пола на выживаемость. Что вы можете сказать о полученных результатах?

```{r}
cox <- coxph(Surv(time, status) ~ sex, data = lung_filt)
summary(cox)
```
Судя по результатам p-value равно 0.136, значит мы не можем отвергнуть нулевую гипотезу
Так же можно сказать, что выживаемость у женщин выше, по сравнению с мужчинами (1-0.7779 = 0.2221 * 100 = 22.21%)














